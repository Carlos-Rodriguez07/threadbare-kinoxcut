name: Import Issues
on:
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Instalar dependencias
        run: pip install requests

      - name: Importar rápido
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'EOF'
          import requests, json, os, time

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["GITHUB_REPOSITORY"]
          
          # Usamos Session para reutilizar la conexión TCP
          session = requests.Session()
          session.headers.update({
              "Authorization": f"token {token}",
              "Accept": "application/vnd.github.v3+json"
          })

          with open("issues.json", "r", encoding="utf-8") as f:
              issues = json.load(f)

          # --- PASO 1: Etiquetas de una sola pasada ---
          print("Sincronizando etiquetas rápidamente...")
          all_labels = {l.get("name"): l for i in issues for l in i.get("labels", []) if isinstance(l, dict)}
          for name, data in all_labels.items():
              session.post(f"https://api.github.com/repos/{repo}/labels", 
                          json={"name": name, "color": data.get("color"), "description": data.get("description", "")})

          # --- PASO 2: Importación de Issues con sleep reducido ---
          print(f"Disparando {len(issues)} issues...")
          for issue in reversed(issues):
              payload = {
                  "title": issue.get("title"),
                  "body": issue.get("body") or "",
                  "labels": [l.get("name") if isinstance(l, dict) else l for l in issue.get("labels", [])]
              }
              
              r = session.post(f"https://api.github.com/repos/{repo}/issues", json=payload)
              
              if r.status_code == 201:
                  print(f"✅ {payload['title']}")
              elif r.status_code == 403: # Si GitHub nos frena
                  print("⚠️ Rate limit detectado, esperando 10 segundos...")
                  time.sleep(10)
              else:
                  print(f"❌ Error: {r.status_code}")
              
              # Bajamos a 0.8 segundos (Equilibrio perfecto velocidad/seguridad)
              time.sleep(0.8) 
          EOF